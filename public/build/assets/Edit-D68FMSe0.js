import{r as n,j as e}from"./client-ZKQMN23D.js";import{d as v}from"./index-Cvft0mqj.js";import{d as ie,a as se}from"./RestoreFromTrash-DbvhuAx3.js";import{d as ne}from"./DeleteForever-CKlUOWKW.js";import{C as ae,a as le,B as k,R as z,b as de,j as N,D as me,M as pe,S as ce,c as he,I as ue,V as fe}from"./MetaInfoManager-B6dBaBkB.js";import{l as b}from"./index.m-DI45-rQC.js";import{S as xe,A as je}from"./AppBarHeader-Bu_GnhUD.js";import{f as ge}from"./Content-CSTk_AN3.js";import{d as E}from"./dayjs.min-BIwLhz4I.js";import"./Listing-BOo8Gk8o.js";import{C as M}from"./Confirm-DlxQ7D7t.js";import"./_baseIsEqual-DkReohVf.js";import{d as ye}from"./Edit-BQczuObD.js";import{C as ve,a as B,T as be,b as Ce,d as Se}from"./RemoveCircle-BP57RAS-.js";import{T as h}from"./Typography-BOH_kjYl.js";import{S}from"./Section-BvcnflQ3.js";import{u as Me,S as we,a as Ie,A as Ye}from"./app-Bt98msSn.js";import{C as Ae}from"./ContentScroll-BWeVEx1a.js";import{I as Fe,a as Re}from"./ItemBrowser-B6m-2ZK6.js";import{S as _e}from"./Sorter-D4ZFKmCa.js";import{B as g}from"./Box-CVOB97vC.js";import{F as De}from"./FormControlLabel-Do0ozMLQ.js";import{B as j}from"./Button-Bs2LlykX.js";import{P as Te}from"./List-BgSNNkKU.js";import{G as I}from"./Grid-BYUzo7jW.js";import{F as H}from"./FormLabel-BgEYUhxt.js";import{I as $,S as L,O}from"./Select-DstqRMzc.js";import{M as V}from"./MenuItem-BvZfPpYr.js";import"./_commonjsHelpers-BosuxZz1.js";import"./browser-D9eauH0H.js";import"./index-edoyAQHv.js";import"./identifier-DHETMsl0.js";import"./TextField-CXY6ukfK.js";import"./extendSxProp-2i1zAAUV.js";import"./useSlotProps-O828vP2f.js";import"./index-BMQyuaGg.js";import"./Grow--1bk2Oiz.js";import"./useTheme-CLvhDb73.js";import"./useThemeWithoutDefault-BU2aPzft.js";import"./useFormControl-CO6OogGI.js";import"./Menu-BfV33fk6.js";import"./ButtonBase-B4crtf6-.js";import"./GlobalStyles-BW4QefxH.js";import"./useDataSource-CV27kxAN.js";import"./axios-DPCeRp2O.js";import"./global-Cavf3q2D.js";import"./index-BDIa4gQt.js";import"./Config-1Zk1eud0.js";import"./_baseEach-DKAn15m2.js";import"./cloneDeep-CpVDZSS9.js";import"./_baseFlatten-7L3oGbN0.js";import"./InputFile-D_iUthKe.js";import"./Add-CSI57y4_.js";import"./Dialog-CPjb0mTO.js";import"./DialogTitle-DqHD2Xkp.js";import"./ListItemIcon-CVfiqn-C.js";import"./ListItemText-7JFmWKqR.js";import"./Tooltip-CvPWsRqB.js";import"./Popper-1aVe17Xg.js";import"./Twitter-DyTnTSc8.js";import"./TableRow-DuG98IK1.js";import"./TableCell-gutrWIi-.js";import"./Close-C7klk6A2.js";import"./DataGridUtils-DqQ54bwL.js";import"./PublishStatusIcon-CFRSoGcQ.js";import"./ColorPickerInput-B-O6o-Qw.js";import"./map-BSSKY85Z.js";import"./index-D3ylJrlI.js";import"./InputAdornment-C1l6JSIr.js";import"./useMediaQuery--fqye5PE.js";import"./getThemeProps-BL5VHue0.js";import"./usePreviousProps-eB1Ppz6I.js";import"./SwitchBase-3IV-eDJc.js";import"./Stack-DUl2B3cg.js";import"./useThemeProps-DZ1rqyJn.js";import"./CircularProgress-CKHSwoEO.js";import"./toPropertyKey-PLuKRk1e.js";import"./Autocomplete-Byzw-jYA.js";import"./Close-mNv2SlFn.js";import"./Checkbox-jThM1nDo.js";import"./index-BqRrtboY.js";import"./utc-BUuWioZ3.js";import"./ThemeProvider-BQTsL86O.js";import"./DragIndicator-CZ3Fox_H.js";import"./lodash-BYTxXjAY.js";const Pe=o=>o.type==="highlight",ke=({videoItem:o,onRemoved:s,sx:t})=>{var a,d;const[i,p]=n.useState(o.contents.at(0));if(n.useEffect(()=>{p(o.contents.at(0))},[o]),!o)return null;const m=(a=i==null?void 0:i.videos)==null?void 0:a.at(0),c=m?(m==null?void 0:m.provider)==="vimeo"?`https://player.vimeo.com/video/${m.provider_id}`:`https://www.youtube-nocookie.com/embed/${m.provider_id}`:null,l=()=>{v.Inertia.get(b("admin.items.edit",{item:o.id}))};return e.jsxs(ve,{sx:{width:320,...t},children:[e.jsx(B,{sx:{p:0},children:e.jsx(be,{value:i==null?void 0:i.lang,onChange:(f,y)=>{var x;return p((x=o.contents)==null?void 0:x.find(({lang:C})=>C===y))},children:(d=o.contents)==null?void 0:d.map(f=>e.jsx(Ce,{label:f.lang,value:f.lang,sx:{minWidth:40}},f.lang))})}),e.jsx(ae,{component:"iframe",src:c||""}),e.jsx(B,{sx:{p:1},children:e.jsx(h,{variant:"body2",fontWeight:"bold",children:i==null?void 0:i.title})}),e.jsxs(le,{sx:{display:"flex",justifyContent:"space-between"},disableSpacing:!0,children:[e.jsx(k,{label:"Remove",buttonProps:{size:"small"},icon:e.jsx(Se,{}),onConfirm:()=>{s&&s()},children:"Remove this video from this context, note that it will not be deleted so it can still be used in other contexts."}),e.jsx(k,{label:"Edit",buttonProps:{size:"small"},icon:e.jsx(ye,{}),onConfirm:l,children:"Leave this screen to edit the image, unsaved changes will be lost."})]})]})},Ee=({annualreport:o,onChange:s})=>{const t=o.items,[i,p]=n.useState(!0),m=()=>{s(t.toSorted((a,d)=>a.publish_at.localeCompare(d.publish_at)))},c=a=>{t.find(({id:d})=>a.id===d)||s([...t,a])},l=n.useMemo(()=>{const a=E().set("date",15).set("year",o.year).set("month",o.month-1);return{filter:{published_before:i?a.endOf("month").utc().format("YYYY-MM-DDTHH:mm:00.000[Z]"):void 0,published_after:i?a.startOf("month").utc().format("YYYY-MM-DDTHH:mm:00.000[Z]"):void 0}}},[o.month,o.year,i]);return e.jsxs(e.Fragment,{children:[e.jsxs(g,{display:"flex",justifyContent:"space-between",gap:1,mb:1,children:[e.jsx(Fe,{onPick:c,sort:"publish_at",browserProps:{label:"Browse for item",buttonProps:{color:"primary",variant:"contained"}},filter:l,extraFilter:e.jsx(De,{label:e.jsxs(g,{display:"flex",flexDirection:"column",children:[e.jsx(h,{children:"Publish period"}),e.jsx(h,{variant:"caption",children:i?e.jsx(e.Fragment,{children:`Only ${E().set("date",1).set("month",o.month-1).set("year",o.year).format("MMM YYYY")}
                                    `}):"Any date"})]}),control:e.jsx(xe,{checked:i,onChange:(a,d)=>p(d),color:"white"})})}),e.jsx(z,{label:"Create resource item",menu:de,onPick:c,buttonProps:{color:"primary"}}),e.jsx(M,{confirmText:"The existing ordering will be reset.",onConfirm:()=>{m()},children:e.jsx(j,{size:"small",children:"Sort by date"})})]}),e.jsx(g,{sx:{maxHeight:500,overflowY:"auto",overflowX:"hidden"},children:t.length===0?e.jsx(h,{children:"No related items"}):e.jsx(_e,{items:t,onChange:s,variant:"column",Renderer:Re})})]})},Be=(o,s)=>{let t;return s.type==="patch"?t={...o,[s.field]:s.value}:s.type==="annualreport_reset"?t=s.annualreport:(console.warn("invalid reducer action",s),t=o),N.diff(t,o)?t:o},fr=({annualreport:o,can:s})=>{var F,R,_,D,T;const[t,i]=n.useReducer(Be,o),[p,m]=n.useState(),{needSave:c,setNeedSave:l}=Me(),[a,d]=n.useState(t.month),[f,y]=n.useState(t.year);n.useEffect(()=>{y(t.year)},[t.year]);const[x,C]=n.useState(),W=n.useCallback(r=>{i({type:"patch",field:"contents",value:r})},[]),G=n.useCallback((r,u)=>{i({type:"patch",field:"items",value:r}),u&&C({severity:"success",message:u})},[]);n.useEffect(()=>{l(!!p)},[l,p]),n.useEffect(()=>{i({type:"annualreport_reset",annualreport:o})},[o]),n.useEffect(()=>{m(N.diff(o,t))},[o,t]);const Z=!!t.deleted_at,X=()=>{v.Inertia.post(b("admin.annualreport.trash",{id:t.id}))},q=()=>{v.Inertia.post(b("admin.annualreport.restore",{id:t.id}))},J=()=>{v.Inertia.delete(b("admin.annualreport.destroyreport",{id:t.id,code:0}))},K=()=>{v.Inertia.patch(b("admin.annualreport.update",{annualreport:t}),p,{preserveState:!1,replace:!0}),l(!1)},Q=()=>{i({type:"annualreport_reset",annualreport:o}),y(o.year),d(o.month)},U=n.useMemo(()=>Array.from({length:12},(r,u)=>({value:(u+1).toString(),label:new Date(0,u).toLocaleString("en",{month:"long"})})),[]),w=new Date().getFullYear(),ee=n.useMemo(()=>Array.from({length:w-1995+1},(r,u)=>{const P=w-u;return{value:P.toString(),label:P.toString()}}),[w]),te=r=>{if(o.year==r)return l(!1),!1;y(r),l(!0),i({type:"patch",field:"year",value:r})},re=r=>{if(o.month==r)return l(!1),!1;d(r),l(!0),i({type:"patch",field:"month",value:r})},[Y,oe]=n.useState(t.video_item),A=r=>{i({type:"patch",field:"video_item_id",value:r==null?void 0:r.id}),oe(r)};return e.jsxs(me,{dispatch:i,children:[e.jsxs(je,{title:`Edit ${t.type}`,children:[e.jsx(j,{variant:"outlined",onClick:Q,color:"secondary",disabled:!c,children:"Reset"}),e.jsx(j,{variant:c?"contained":"outlined",onClick:K,color:"secondary",disabled:!c,children:"Save"})]}),e.jsxs(Ae,{children:[x&&e.jsx(we,{open:!0,autoHideDuration:6e3,anchorOrigin:{vertical:"bottom",horizontal:"center"},onClose:()=>C(void 0),TransitionComponent:Ie,children:e.jsx(Ye,{severity:x.severity,elevation:6,children:x.message})}),e.jsxs("form",{autoComplete:"off",autoCapitalize:"off",children:[e.jsx(g,{padding:2,children:e.jsx(h,{variant:"h4",children:ge(t)||t.contents[0].title||"-no title-"})}),e.jsx(pe,{item:t}),e.jsx(g,{p:2,children:e.jsx(Te,{sx:{p:2},children:e.jsxs(I,{container:!0,spacing:2,children:[e.jsx(I,{item:!0,xs:6,children:e.jsxs(H,{sx:{m:1},style:{marginLeft:"0px"},fullWidth:!0,children:[e.jsx($,{id:"year-label",children:"Year*"}),e.jsx(L,{labelId:"year-label",id:"year",name:"year",value:f,onChange:r=>te(Number(r.target.value)),input:e.jsx(O,{label:"Year*"}),children:ee.map(r=>e.jsx(V,{value:r.value,children:r.label},r.value))})]})}),t.type!=="summary"&&e.jsx(e.Fragment,{children:e.jsx(I,{item:!0,xs:6,children:e.jsxs(H,{sx:{m:1},fullWidth:!0,children:[e.jsx($,{id:"month-label",children:"Month*"}),e.jsx(L,{labelId:"month-label",id:"month",name:"month",value:a,onChange:r=>re(Number(r.target.value)),input:e.jsx(O,{label:"Month*"}),children:U.map(r=>e.jsx(V,{value:r.value,children:r.label},r.value))})]})})})]})})}),e.jsx(S,{title:"Contents",open:!0,summary:e.jsx(ce,{contents:[{title:"Languages",text:((F=t.contents)==null?void 0:F.map(({lang:r})=>r).join(", "))||"No content"}]}),children:e.jsx(he,{contents:t.contents,fields:["title","blurb","content"],htmlFields:{content:"full",blurb:"limited"},onChange:W})}),t.type==="summary"&&e.jsx(h,{px:4,children:"The first regular image is used for the tile in the Activity Reports overview listing, the support color is used here as well. If a portrait image is added it is used in the summary on the annual report timeline."}),e.jsx(ue,{images:t.all_images,singleImage:t.type==="highlight",support_color:t.support_color}),Pe(t)&&e.jsxs(e.Fragment,{children:[e.jsx(S,{title:"Related items",open:!0,summary:e.jsxs(h,{children:[((R=t.items)==null?void 0:R.length)||0," ","related items"]}),children:e.jsx(Ee,{annualreport:t,onChange:G})}),e.jsx(S,{title:"Actions",children:e.jsx(g,{display:"flex",gap:2,children:Z?e.jsxs(e.Fragment,{children:[((_=s==null?void 0:s.annualreports)==null?void 0:_.restoreMany)&&e.jsx(M,{onConfirm:q,children:e.jsx(j,{variant:"contained",startIcon:e.jsx(ie,{}),children:"Restore from Trash"})}),((D=s==null?void 0:s.annualreports)==null?void 0:D.forceDeleteMany)&&e.jsx(M,{onConfirm:J,children:e.jsx(j,{variant:"contained",color:"error",startIcon:e.jsx(ne,{}),children:"Delete permanently"})})]}):e.jsx(e.Fragment,{children:((T=s==null?void 0:s.annualreports)==null?void 0:T.deleteMany)&&e.jsx(M,{onConfirm:X,children:e.jsx(j,{variant:"contained",color:"primary",startIcon:e.jsx(se,{}),children:"Move to Trash"})})})})})]}),t.type==="summary"&&e.jsxs(S,{title:"Video (optional)",open:!0,children:[e.jsx(h,{children:"If a video is added, it is shown instead of the portrait on the Annual Report page"}),Y&&e.jsx(ke,{videoItem:Y,onRemoved:()=>A(void 0)}),(!t.video_item||!0)&&e.jsx(z,{label:t.video_item?"Choose another video":"Add video",menu:fe,onPick:r=>{A(r)}})]})]}),!1]})]})};export{fr as default};
